# BPHT Evaluation Workflow

Evaluates the access and fill times of BPHTs compared to an implementation with a dedicated hop bit table.
This includes tests with randomized keys as well as with q-grams from reference genomes.
Plots generated by this workflow are stored in `plots` folder.

## Requirements

This snakemake workflow executes several evaluation programs from the `bpht_eval` Rust program.
In default (desktop) configuration, only a small amount of the evaluations are performed.
For the full workflow, change the configuration file in the `Snakefile` from `"config_desktop.yaml"` to `"config_server.yaml"`.
This changes both the number of runs and parameter configurations executed per evaluation as well as the evaluated genomes.
Results presented in my thesis were obtained using the server configuration.

Both versions of this workflow automatically download reference genomes.
While for the desktop configuration only small genomes are used, the server configuration will download about 5 GB of zipped `.fasta.gz` files.
The analyzed genomes can be selected in the respective configuration file.
For example the section
  ```yaml
  target_genomes:
    # - hg38
    # - hops
    - mxanthus
    - pfalciparum
  ```
in `"config_desktop.yaml"` specifies that only the `mxanthus` and `pfalciparum` genomes will be analyzed.
To select additional genomes for analysis uncomment the respective lines.
The download paths for these files and their local file system paths are specified in the file `"genomes.tsv"`.


This workflow requires `numactl`, `conda`, and `snakemake` to be installed.
On Ubuntu, `numactl` can be installed from the package repositories:

```bash
sudo apt install numactl
```

For an installation guide for `conda`, please refer to the [conda website](https://docs.conda.io/projects/conda/en/latest/).
This workflow requires the [Python 3 version](https://docs.conda.io/en/latest/miniconda.html) of `(mini)conda`.

We recommend installing `snakemake` via the conda package manager using the bioconda channel to obtain a recent version.
```bash
conda install -c conda-forge -c bioconda snakemake
```
This workflow was tested with `snakemake==5.20.1`.

Note that the full workflow (using `"config_server.yaml"`) requires several TB of disk space as well as 128 GB of RAM.

## Usage

Note that the access time comparison was designed to run on a specific compute server with two numa blocks.
This evaluation code might not translate to another architecture.

```bash
snakemake --use-conda --jobs 2 --resource numa_0=1 --resource numa_1=1
```

Without specifying numa blocks, numa crossover due to high memory requirements can obfuscate the results.
However, when running the desktop configuration which only uses one numa block, the numa resources can be omitted:

```bash
snakemake --use-conda --jobs 1
```
